{% extends 'keycloak_admin/base.html' %}

{% block title %}Users - Keycloak Admin{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#searchModal">
        <i class="fas fa-search"></i> Search
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Search Modal -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search Users</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="get">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search"
                                   value="{{ request.GET.search }}" placeholder="Username, email...">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="enabled" class="form-label">Status</label>
                            <select class="form-select" id="enabled" name="enabled">
                                <option value="">All</option>
                                <option value="true" {% if request.GET.enabled == 'true' %}selected{% endif %}>Enabled</option>
                                <option value="false" {% if request.GET.enabled == 'false' %}selected{% endif %}>Disabled</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <a href="{% url 'keycloak_admin:user_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Create User Form -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-success">
                    <i class="fas fa-user-plus"></i> Create New User
                </h6>
            </div>
            <div class="card-body">
                <form method="post" id="createUserForm">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label">
                                Username <span class="text-danger">*</span>
                            </label>
                            {{ form.username }}
                            {% if form.username.errors %}
                                <div class="text-danger small">
                                    {% for error in form.username.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.username.help_text }}</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                Email <span class="text-danger">*</span>
                            </label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="text-danger small">
                                    {% for error in form.email.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.email.help_text }}</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name</label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                                <div class="text-danger small">
                                    {% for error in form.first_name.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name</label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                                <div class="text-danger small">
                                    {% for error in form.last_name.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.password.id_for_label }}" class="form-label">Password</label>
                            {{ form.password }}
                            {% if form.password.errors %}
                                <div class="text-danger small">
                                    {% for error in form.password.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.password.help_text }}</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.confirm_password.id_for_label }}" class="form-label">Confirm Password</label>
                            {{ form.confirm_password }}
                            {% if form.confirm_password.errors %}
                                <div class="text-danger small">
                                    {% for error in form.confirm_password.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form.enabled }}
                                <label class="form-check-label" for="{{ form.enabled.id_for_label }}">
                                    Enable Account
                                </label>
                                <div class="form-text">{{ form.enabled.help_text }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Assign Permissions</label>
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <p class="card-text small text-muted mb-3">
                                        Select the permissions you want to assign to this user. Users will be able to perform actions based on their assigned permissions.
                                    </p>
                                    <div class="row">
                                        {% for choice in form.permissions.field.choices %}
                                        <div class="col-md-6 mb-2">
                                            <div class="form-check">
                                                <input type="checkbox"
                                                       name="{{ form.permissions.html_name }}"
                                                       value="{{ choice.0 }}"
                                                       class="form-check-input"
                                                       id="permission_{{ choice.0 }}">
                                                <label class="form-check-label" for="permission_{{ choice.0 }}">
                                                    {% if 'tasks' in choice.0 %}
                                                        <span class="permission-badge badge-tasks">{{ choice.0 }}</span>
                                                    {% elif 'integrations' in choice.0 %}
                                                        <span class="permission-badge badge-integrations">{{ choice.0 }}</span>
                                                    {% elif 'admin' in choice.0 %}
                                                        <span class="permission-badge badge-admin">{{ choice.0 }}</span>
                                                    {% else %}
                                                        <span class="permission-badge">{{ choice.0 }}</span>
                                                    {% endif %}
                                                </label>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="form-text">{{ form.permissions.help_text }}</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-user-plus"></i> Create User
                            </button>
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="card shadow">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-users"></i> Users
            {% if page_obj %}
                <span class="badge bg-secondary ms-2">{{ page_obj.paginator.count }} total</span>
            {% endif %}
        </h6>
    </div>
    <div class="card-body">
        {% if page_obj %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in page_obj %}
                        <tr>
                            <td>
                                <strong>{{ user.username }}</strong>
                                {% if user.emailVerified %}
                                    <i class="fas fa-check-circle text-success" title="Email verified"></i>
                                {% endif %}
                            </td>
                            <td>{{ user.email|default:"-" }}</td>
                            <td>
                                {% if user.firstName or user.lastName %}
                                    {{ user.firstName|default:"" }} {{ user.lastName|default:"" }}
                                {% else %}
                                    <span class="text-muted">Not set</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.enabled %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-danger">Disabled</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.createdTimestamp %}
                                    {{ user.createdTimestamp|date:"Y-m-d" }}
                                {% else %}
                                    <span class="text-muted">Unknown</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'keycloak_admin:user_detail' user.id %}"
                                       class="btn btn-outline-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="#" class="btn btn-outline-info" title="Reset Password"
                                       onclick="resetPassword('{{ user.id }}', '{{ user.username }}')">
                                        <i class="fas fa-key"></i>
                                    </a>
                                    {% if user.enabled %}
                                        <a href="#" class="btn btn-outline-warning" title="Disable User"
                                           onclick="toggleUserStatus('{{ user.id }}', '{{ user.username }}', false)">
                                            <i class="fas fa-ban"></i>
                                        </a>
                                    {% else %}
                                        <a href="#" class="btn btn-outline-success" title="Enable User"
                                           onclick="toggleUserStatus('{{ user.id }}', '{{ user.username }}', true)">
                                            <i class="fas fa-check"></i>
                                        </a>
                                    {% endif %}
                                    <a href="#" class="btn btn-outline-danger" title="Delete User"
                                       onclick="deleteUser('{{ user.id }}', '{{ user.username }}')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5>No users found</h5>
                <p class="text-muted">Get started by creating your first user.</p>
                <a href="{% url 'keycloak_admin:user_create' %}" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> Create User
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the user <strong id="deleteUsername"></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <form method="post" id="deleteForm">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete User
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="resetPasswordForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" name="new_password" required>
                        <div class="form-text">Minimum 8 characters.</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="temporaryPassword" name="temporary">
                            <label class="form-check-label" for="temporaryPassword">
                                User must change password on next login
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitPasswordReset()">
                    <i class="fas fa-key"></i> Reset Password
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.permission-badge {
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 0.75em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    margin-bottom: 2px;
}

.badge-tasks {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.badge-integrations {
    background: linear-gradient(135deg, #17a2b8, #007bff);
    color: white;
}

.badge-admin {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    color: #212529;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentUserId = null;

// Form validation for create user form
document.addEventListener('DOMContentLoaded', function() {
    const createUserForm = document.getElementById('createUserForm');
    if (createUserForm) {
        createUserForm.addEventListener('submit', function(e) {
            const password = document.getElementById('id_password').value;
            const confirmPassword = document.getElementById('id_confirm_password').value;
            const username = document.getElementById('id_username').value;
            const email = document.getElementById('id_email').value;

            // Basic validation
            if (!username.trim()) {
                e.preventDefault();
                alert('Username is required.');
                return;
            }

            if (!email.trim()) {
                e.preventDefault();
                alert('Email is required.');
                return;
            }

            if (password && password !== confirmPassword) {
                e.preventDefault();
                alert('Passwords do not match.');
                return;
            }

            if (password && password.length < 8) {
                e.preventDefault();
                alert('Password must be at least 8 characters long.');
                return;
            }
        });
    }
});

function deleteUser(userId, username) {
    currentUserId = userId;
    document.getElementById('deleteUsername').textContent = username;
    document.getElementById('deleteForm').action = `/keycloak-admin/users/${userId}/delete/`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function resetPassword(userId, username) {
    currentUserId = userId;
    document.getElementById('resetPasswordForm').reset();
    new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

function submitPasswordReset() {
    const password = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const temporary = document.getElementById('temporaryPassword').checked;

    if (password !== confirmPassword) {
        alert('Passwords do not match!');
        return;
    }

    if (password.length < 8) {
        alert('Password must be at least 8 characters long!');
        return;
    }

    // This would need to be implemented in the views
    alert('Password reset functionality needs to be implemented in the backend.');
}

function toggleUserStatus(userId, username, enable) {
    const action = enable ? 'enable' : 'disable';
    const confirmText = `Are you sure you want to ${action} the user ${username}?`;

    if (confirm(confirmText)) {
        // This would need to be implemented in the views
        alert(`User ${action} functionality needs to be implemented in the backend.`);
    }
}
</script>
{% endblock %}