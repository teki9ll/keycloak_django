{% extends 'keycloak_admin/base.html' %}

{% block title %}Roles - Keycloak Admin{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="{% url 'keycloak_admin:role_create' %}" class="btn btn-success">
        <i class="fas fa-plus-circle"></i> Create Role
    </a>
    <a href="{% url 'keycloak_admin:permission_create' %}" class="btn btn-warning">
        <i class="fas fa-shield-alt"></i> Create Permission
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Roles and Permissions Cards -->
<div class="row">
    <!-- Regular Roles Card -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-user-tag"></i> Roles
                    <span class="badge bg-primary ms-2">{{ regular_roles|length }}</span>
                </h6>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshRoles()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if regular_roles %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Role Name</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for role in regular_roles %}
                                <tr>
                                    <td>
                                        {% if 'admin' in role.name %}
                                            <span class="role-badge badge-role-admin">{{ role.name }}</span>
                                        {% elif 'manager' in role.name %}
                                            <span class="role-badge badge-role-manager">{{ role.name }}</span>
                                        {% elif 'user' in role.name %}
                                            <span class="role-badge badge-role-user">{{ role.name }}</span>
                                        {% else %}
                                            <span class="role-badge badge-role-default">{{ role.name }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ role.description|default:"-" }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'keycloak_admin:role_permissions' role.name %}"
                                               class="btn btn-outline-info" title="Manage Permissions">
                                                <i class="fas fa-shield-alt"></i>
                                            </a>
                                            <button class="btn btn-outline-warning"
                                                    onclick="deleteRole('{{ role.name }}')"
                                                    title="Delete Role">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-user-tag fa-3x text-muted mb-3"></i>
                        <h5>No roles found</h5>
                        <p class="text-muted">Create your first role to get started.</p>
                        <a href="{% url 'keycloak_admin:role_create' %}" class="btn btn-success">
                            <i class="fas fa-plus-circle"></i> Create Role
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Permissions Card -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-warning">
                    <i class="fas fa-shield-alt"></i> Permissions
                    <span class="badge bg-warning ms-2">{{ permission_roles|length }}</span>
                </h6>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshPermissions()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if permission_roles %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Permission</th>
                                    <th>Description</th>
                                    <th>Assigned To</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for permission in permission_roles %}
                                <tr>
                                    <td>
                                        {% if 'tasks' in permission.name %}
                                            <span class="permission-badge badge-tasks">{{ permission.name }}</span>
                                        {% elif 'integrations' in permission.name %}
                                            <span class="permission-badge badge-integrations">{{ permission.name }}</span>
                                        {% elif 'admin' in permission.name %}
                                            <span class="permission-badge badge-admin">{{ permission.name }}</span>
                                        {% else %}
                                            <span class="permission-badge">{{ permission.name }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ permission.description|default:"-" }}</td>
                                    <td>
                                        <small class="text-muted">
                                            <!-- This would require additional API calls to show which roles have this permission -->
                                            View details
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
                        <h5>No permissions found</h5>
                        <p class="text-muted">Create permissions to assign to roles.</p>
                        <a href="{% url 'keycloak_admin:permission_create' %}" class="btn btn-warning">
                            <i class="fas fa-shield-alt"></i> Create Permission
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Role Creation Guide -->
<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-info">
                    <i class="fas fa-info-circle"></i> Role & Permission Guide
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="border p-3 rounded">
                            <h6 class="text-primary">ðŸ“‹ Available Permissions</h6>
                            <ul class="list-unstyled small">
                                <li><span class="permission-badge">manage_tasks</span> - Create/update/delete tasks</li>
                                <li><span class="permission-badge">manage_integrations</span> - Configure integrations</li>
                                <li><span class="permission-badge">manage_admin</span> - Admin functions</li>
                                <li><span class="permission-badge">view_reports</span> - View analytics</li>
                                <li><span class="permission-badge">manage_users</span> - Manage users</li>
                                <li><span class="permission-badge">manage_roles</span> - Manage roles</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border p-3 rounded">
                            <h6 class="text-success">ðŸ‘¥ Role Hierarchy</h6>
                            <ul class="list-unstyled small">
                                <li><span class="role-badge">admin</span> - All permissions</li>
                                <li><span class="role-badge">manager</span> - Tasks, integrations, reports</li>
                                <li><span class="role-badge">user</span> - Basic task management</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border p-3 rounded">
                            <h6 class="text-info">ðŸ”§ Quick Actions</h6>
                            <div class="d-grid gap-2">
                                <a href="{% url 'keycloak_admin:role_create' %}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-plus"></i> Create Role
                                </a>
                                <a href="{% url 'keycloak_admin:permission_create' %}" class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-shield-alt"></i> Create Permission
                                </a>
                                <a href="{% url 'keycloak_admin:user_list' %}" class="btn btn-sm btn-outline-info">
                                    <i class="fas fa-users"></i> Manage Users
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the role <strong id="deleteRoleName"></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
                <p class="text-warning small">
                    <i class="fas fa-exclamation-triangle"></i>
                    Make sure no users are assigned to this role before deleting.
                </p>
            </div>
            <div class="modal-footer">
                <form method="post" id="deleteForm">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Role
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.role-badge {
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 0.75em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}

.badge-role-admin {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.badge-role-manager {
    background: linear-gradient(135deg, #6f42c1, #5a32a3);
    color: white;
}

.badge-role-user {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
}

.badge-role-default {
    background: linear-gradient(135deg, #6c757d, #5a6268);
    color: white;
}

.permission-badge {
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 0.75em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}

.badge-tasks {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.badge-integrations {
    background: linear-gradient(135deg, #17a2b8, #007bff);
    color: white;
}

.badge-admin {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    color: #212529;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function deleteRole(roleName) {
    document.getElementById('deleteRoleName').textContent = roleName;
    document.getElementById('deleteForm').action = `/admin/roles/${encodeURIComponent(roleName)}/delete/`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function refreshRoles() {
    location.reload();
}

function refreshPermissions() {
    location.reload();
}

// Add some interactive behavior
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to badges
    const badges = document.querySelectorAll('.role-badge, .permission-badge');
    badges.forEach(badge => {
        badge.style.transition = 'transform 0.2s ease';
        badge.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
        });
        badge.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
});
</script>
{% endblock %}