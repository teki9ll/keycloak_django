{% extends 'app/base.html' %}

{% block title %}Dashboard - {{ user.username }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="user-card">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <div class="keycloak-logo">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="col-md-8">
                    <h2 class="mb-1">Welcome back, {{ user.username }}!</h2>
                    <p class="mb-2 opacity-75">{{ user_info.email|default:"No email provided" }}</p>
                    <div class="mt-3">
                        {% for role in user.roles %}
                        <span class="role-badge
                            {% if role == 'admin' %}role-admin
                            {% elif role == 'manager' %}role-manager
                            {% else %}role-user{% endif %}">
                            <i class="fas fa-tag"></i> {{ role|title }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-2 text-end">
                    <form method="post" action="/auth/logout/" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to logout?')">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </form>
                    <form method="post" action="/auth/keycloak-logout/" style="display: inline; margin-top: 5px;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Logout from all devices">
                            <i class="fas fa-shield-alt"></i> Full Logout
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- User Information Card -->
    <div class="col-md-6">
        <div class="card info-card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user-circle"></i> User Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td class="text-muted fw-bold">Username:</td>
                        <td>{{ user.username }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted fw-bold">Email:</td>
                        <td>{{ user_info.email|default:"N/A" }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted fw-bold">Full Name:</td>
                        <td>{{ user_info.name|default:"N/A" }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted fw-bold">User ID:</td>
                        <td><small class="text-muted">{{ user_info.sub|default:"N/A" }}</small></td>
                    </tr>
                    <tr>
                        <td class="text-muted fw-bold">Email Verified:</td>
                        <td>
                            {% if user_info.email_verified %}
                            <span class="badge bg-success"><i class="fas fa-check"></i> Verified</span>
                            {% else %}
                            <span class="badge bg-warning"><i class="fas fa-exclamation-triangle"></i> Not Verified</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- Roles & Permissions Card -->
    <div class="col-md-6">
        <div class="card info-card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Roles & Permissions</h5>
            </div>
            <div class="card-body">
                <h6 class="fw-bold text-muted mb-3">Assigned Roles:</h6>
                {% if user.roles %}
                    {% for role in user.roles %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <span>
                            <i class="fas fa-user-tag text-primary"></i>
                            <strong>{{ role|title }}</strong>
                        </span>
                        <div>
                            {% if role == 'admin' %}
                            <span class="badge bg-danger">Full Access</span>
                            {% elif role == 'manager' %}
                            <span class="badge bg-info">Management</span>
                            {% else %}
                            <span class="badge bg-secondary">User</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <p class="text-muted">No specific roles assigned</p>
                {% endif %}

                <hr>

                <h6 class="fw-bold text-muted mb-3">System Permissions:</h6>
                <div class="list-group list-group-flush">
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-sign-in-alt"></i> Can Login</span>
                            <span class="badge bg-success">Yes</span>
                        </div>
                    </div>
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-tachometer-alt"></i> Access Dashboard</span>
                            <span class="badge bg-success">Yes</span>
                        </div>
                    </div>
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-user-shield"></i> Admin Access</span>
                            {% if 'admin' in user.roles %}
                            <span class="badge bg-success">Yes</span>
                            {% else %}
                            <span class="badge bg-danger">No</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-users-cog"></i> Manager Access</span>
                            {% if 'admin' in user.roles or 'manager' in user.roles %}
                            <span class="badge bg-success">Yes</span>
                            {% else %}
                            <span class="badge bg-danger">No</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Session Information Card -->
    <div class="col-md-6">
        <div class="card info-card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Session Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td class="text-muted fw-bold">Authenticated:</td>
                        <td>
                            {% if user.is_authenticated %}
                            <span class="badge bg-success"><i class="fas fa-check-circle"></i> Yes</span>
                            {% else %}
                            <span class="badge bg-danger"><i class="fas fa-times-circle"></i> No</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted fw-bold">User Type:</td>
                        <td>
                            {% if 'admin' in user.roles %}
                            <span class="text-danger fw-bold">Administrator</span>
                            {% elif 'manager' in user.roles %}
                            <span class="text-info fw-bold">Manager</span>
                            {% else %}
                            <span class="text-success fw-bold">Regular User</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted fw-bold">Session Token:</td>
                        <td>
                            {% if session_info.token_present %}
                            <span class="badge bg-success"><i class="fas fa-key"></i> Active</span>
                            {% else %}
                            <span class="badge bg-warning"><i class="fas fa-exclamation-triangle"></i> Missing</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted fw-bold">Authentication Method:</td>
                        <td><span class="badge bg-primary">Keycloak OAuth2</span></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- Quick Actions Card -->
    <div class="col-md-6">
        <div class="card info-card h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="callAPI('/api/dashboard/', 'dashboard-result')">
                        <i class="fas fa-code"></i> View API Data (JSON)
                    </button>
                    {% if 'admin' in user.roles %}
                    <button class="btn btn-outline-danger" onclick="callAPI('/api/admin/', 'admin-result')">
                        <i class="fas fa-user-shield"></i> Admin Panel API
                    </button>
                    {% endif %}
                    {% if 'admin' in user.roles or 'manager' in user.roles %}
                    <button class="btn btn-outline-info" onclick="callAPI('/api/manager/', 'manager-result')">
                        <i class="fas fa-users-cog"></i> Manager Panel API
                    </button>
                    {% endif %}
                    <button class="btn btn-outline-success" onclick="callAPI('/api/auth/status/', 'auth-result')">
                        <i class="fas fa-info-circle"></i> Check Auth Status
                    </button>
                    <hr>
                    <button class="btn btn-outline-secondary" onclick="showTokenInfo()">
                        <i class="fas fa-eye"></i> View Token Details
                    </button>
                </div>

                <!-- API Results Display -->
                <div id="api-results" style="display: none;">
                    <hr>
                    <h6 class="fw-bold text-muted">API Response:</h6>
                    <div id="api-result-content" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                        <pre><code id="api-result-text"></code></pre>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="hideAPIResults()">Hide Results</button>
                </div>

                <!-- Token Details (Hidden by default) -->
                <div id="tokenDetails" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Session Information</h6>
                        <small class="text-muted">
                            This is a stateless authentication system. User data is not stored in a database.
                            Each request validates the JWT token with Keycloak.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Information -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card info-card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> System Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="fw-bold text-muted">Keycloak Configuration</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-server text-primary"></i> Server: <code>172.28.136.214:8080</code></li>
                            <li><i class="fas fa-globe text-info"></i> Realm: <code>teki_9</code></li>
                            <li><i class="fas fa-id-badge text-success"></i> Client: <code>easytask</code></li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="fw-bold text-muted">Authentication Flow</h6>
                        <ol class="small text-muted">
                            <li>User clicks login</li>
                            <li>Redirect to Keycloak</li>
                            <li>Authenticate with Keycloak</li>
                            <li>Receive JWT token</li>
                            <li>Access dashboard with user data</li>
                        </ol>
                    </div>
                    <div class="col-md-4">
                        <h6 class="fw-bold text-muted">Security Features</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-shield-alt text-success"></i> PKCE for security</li>
                            <li><i class="fas fa-random text-warning"></i> State parameter validation</li>
                            <li><i class="fas fa-key text-primary"></i> JWT token validation</li>
                            <li><i class="fas fa-sign-out-alt text-danger"></i> Proper logout handling</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showTokenInfo() {
    const tokenDiv = document.getElementById('tokenDetails');
    if (tokenDiv.style.display === 'none') {
        tokenDiv.style.display = 'block';
    } else {
        tokenDiv.style.display = 'none';
    }
}

function callAPI(endpoint, resultId) {
    console.log(`Calling API: ${endpoint}`);

    // Show loading state
    const resultContent = document.getElementById('api-result-content');
    const resultText = document.getElementById('api-result-text');
    const resultsDiv = document.getElementById('api-results');

    resultText.textContent = 'Loading...';
    resultsDiv.style.display = 'block';

    // Make the API call
    fetch(endpoint)
        .then(response => {
            console.log(`Response status: ${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);
            resultText.textContent = JSON.stringify(data, null, 2);

            // Add success styling
            resultContent.className = 'bg-light p-3 rounded border border-success';
        })
        .catch(error => {
            console.error('API Error:', error);
            resultText.textContent = `Error: ${error.message}`;

            // Add error styling
            resultContent.className = 'bg-light p-3 rounded border border-danger';
        });
}

function hideAPIResults() {
    document.getElementById('api-results').style.display = 'none';
}

// Auto-refresh session status every 30 seconds
setTimeout(function() {
    fetch('/api/auth/status/')
        .then(response => response.json())
        .then(data => {
            console.log('Auth status checked:', data);
        })
        .catch(error => {
            console.error('Error checking auth status:', error);
        });
}, 30000);
</script>
{% endblock %}